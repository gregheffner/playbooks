---
- name: Update and restart Podman containers
  hosts: all
  become: true

  tasks:
    - name: Update Podman packages
      yum:
        name: podman
        state: latest
      when: ansible_os_family != "Darwin"

    - name: Get list of all container IDs
      shell: podman ps -aq
      register: container_ids
      changed_when: false

    - name: Restart all Podman containers
      shell: podman restart {{ item }}
      with_items: "{{ container_ids.stdout_lines }}"
      when: container_ids.stdout_lines | length > 0

    - name: Schedule Ansible playbook to run monthly
      cron:
        name: "Run update.yml playbook"
        minute: "0"
        hour: "1"
        day: "1"
        job: "ansible-playbook /home/ansible/ansibleStuff/playbooks/update.yml"
        user: "ansible"

    - name: Update all Homebrew packages
      homebrew:
        update_homebrew: yes
        upgrade_all: yes
      when: ansible_os_family == "Darwin"

    - name: Update all DNF packages
      dnf:
        name: '*'
        state: latest
      when: ansible_os_family == "RedHat"    
    
    - name: Append to local file
      delegate_to: centOS
      lineinfile:
        path: "./updates.txt"
        line: "Last update: {{ ansible_date_time.iso8601 }}"